<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magicblob</title>
  <link rel="icon" type="image/png" href="assets/logobrowser.png">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #000000;
      --bg-card: #000000;
      --bg-elevated: #000000;
      --border: rgb(166, 166, 166);
      --border-hover: rgb(217, 0, 255);
      --text: #ffffff;
      --text-dim: #8b8b96;
      --text-muted: #5c5c66;
      --accent: #FFFEF0;
      --accent-dim: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%); 
      --accent-gradient: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%); 
      --green: #22c55e;
      --green-dim: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-dim: rgb(63, 26, 26);
      --purple: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%); 
      --orange: #BA00FF;
      --pink: #6E1742;
      --yellow: #eab308;
      --cyan: #06b6d4;
    }

    html {
      background: var(--bg);
      overscroll-behavior: none;
    }

    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overscroll-behavior: none;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      transition: padding 0.3s ease;
    }

    /* Larger horizontal padding on big screens */
    @media (min-width: 1600px) {
      .header {
        padding: 1rem 2.5rem;
      }
      .header-bottom {
        padding: 0 2.5rem;
      }
      .activity-ticker {
        padding: 0 2.5rem;
      }
      .main {
        padding: 2rem 2.5rem;
      }
    }

    .header-inner {
      max-width: 1920px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      transition: gap 0.3s ease;
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      text-decoration: none;
    }

    .logo-img {
      height: 40px;
      width: auto;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-gradient);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg { width: 18px; height: 18px; color: white; }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .tab-btns {
      display: flex;
      background: var(--bg-card);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      color: var(--text-dim);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .tab-btn:hover { color: var(--text); }
    }
    .tab-btn.active { background: var(--accent-gradient); color: white; }

    /* Mobile tabs - hidden on desktop */
    .mobile-tabs {
      display: none;
    }

    .share-btn, .login-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: var(--accent-gradient);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .share-btn:hover, .login-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    }
    .share-btn svg, .login-btn svg { width: 18px; height: 18px; }

    .leaderboard-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1.25rem;
      text-decoration: none;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .leaderboard-btn:hover {
        border-color: var(--border-hover);
        transform: translateY(-1px);
      }
    }

    .leaderboard-trophy {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .profile-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--purple);
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s;
      background: var(--bg-card);
    }

    @media (hover: hover) {
      .profile-btn:hover { border-color: var(--text); transform: scale(1.05); }
    }
    .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

    /* Search Bar */
    .search-container {
      position: relative;
      flex: 1;
      max-width: 600px;
      margin: 0 1rem;
    }

    @media (min-width: 1600px) {
      .search-container {
        max-width: 800px;
      }
    }

    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 2rem 0 2.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--purple);
      background: var(--bg-elevated);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .search-clear:hover {
      color: var(--text);
      background: var(--border-hover);
    }

    .search-clear.visible {
      display: flex;
    }

    .search-clear svg {
      width: 10px;
      height: 10px;
    }

    .header-bottom {
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 1920px;
      margin: 0.75rem auto 0;
      padding: 0 1.5rem;
      gap: 1rem;
      position: relative;
    }

    .category-filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    @media (min-width: 701px) {
      .tab-btns {
        position: absolute;
        right: 1.5rem;
      }
    }

    .cat-filter {
      padding: 0.4rem 0.75rem;
      border: 1px solid var(--border);
      background: transparent;
      border-radius: 20px;
      color: var(--text-dim);
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    /* Only apply hover on devices that support it (not touch) */
    @media (hover: hover) {
      .cat-filter:hover { border-color: rgba(255, 254, 240, 1); color: var(--text); }
    }
    
    .cat-filter.active { 
      border-color: var(--purple); 
      background: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%);  
      color: var(--purple); 
    }

    /* Activity Ticker */
    .activity-ticker {
      max-width: 1920px;
      margin: 0.75rem auto 0;
      padding: 0 1.5rem;
    }
    
    .ticker-wrapper {
      overflow: hidden;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .ticker-track {
      display: flex;
      animation: ticker 30s linear infinite;
      width: max-content;
    }

    .ticker-track:hover {
      animation-play-state: paused;
    }

    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .ticker-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-right: 1px solid var(--border);
      white-space: nowrap;
      flex-shrink: 0;
      cursor: pointer;
    }

    .ticker-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .ticker-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .ticker-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ticker-handle {
      font-size: 0.75rem;
      color: var(--text-dim);
      font-weight: 500;
    }

    .ticker-cats {
      display: flex;
      gap: 0.25rem;
    }

    .ticker-cat {
      padding: 0.15rem 0.4rem;
      border-radius: 8px;
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      background: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%);
      color: var(--purple);
    }

    .ticker-empty {
      padding: 0.5rem 1rem;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      width: 100%;
    }

    .cat-filter .cat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .main {
      max-width: 1920px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .empty-state { text-align: center; padding: 4rem 1rem; }

    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      background: var(--bg-card);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .empty-icon svg { width: 28px; height: 28px; color: var(--text-muted); }
    .empty-state h2 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .empty-state p { color: var(--text-dim); margin-bottom: 1.5rem; }

    .loading { text-align: center; padding: 4rem 1rem; color: var(--text-dim); }

    .grid { columns: 4; column-gap: 1rem; }
    @media (min-width: 1400px) { .grid { columns: 5; } }
    @media (min-width: 1800px) { .grid { columns: 6; } }
    @media (max-width: 1200px) { .grid { columns: 3; } }
    @media (max-width: 800px) { .grid { columns: 2; } }
    @media (max-width: 500px) { .grid { columns: 1; } }

    .post-card {
      position: relative;
      break-inside: avoid;
      margin-bottom: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .post-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
    }

    .post-image { width: 100%; display: block; background: var(--bg-elevated); }

    .post-no-image {
      width: 100%;
      aspect-ratio: 16/9;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .post-body { padding: 1rem; }

    .post-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .post-author {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
      flex-shrink: 0;
    }

    .author-avatar {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      overflow: hidden;
    }

    .author-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .author-handle { font-size: 0.85rem; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }

    .post-categories {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      flex: 1;
      justify-content: flex-end;
    }

    .cat-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%);
      color: var(--purple);
    }

    .post-card {
      cursor: pointer;
    }

    .post-text {
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--text);
      margin-bottom: 0.75rem;
    }

    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .post-footer-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .post-time {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .twitter-link {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.75rem;
      transition: color 0.2s;
    }

    .twitter-link:hover { color: var(--text-dim); }
    .twitter-link svg { width: 14px; height: 14px; }

    .vote-btns { display: flex; gap: 0.5rem; }

    .vote-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.625rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vote-btn svg { width: 14px; height: 14px; }
    .vote-btn img { width: 14px; height: 14px; object-fit: contain; }
    .vote-btn:hover:not(:disabled) { border-color: var(--border-hover); color: var(--text); }
    .vote-btn.up.active { background: var(--green-dim); border-color: var(--green); color: var(--green); }
    .vote-btn.down.active { background: var(--red-dim); border-color: var(--red); color: var(--red); }
    .vote-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* AI Slop Button */
    .slop-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .slop-btn:hover:not(:disabled) { 
      border-color: var(--pink); 
      color: var(--pink);
      background: rgba(255,55,95,0.1);
    }
    
    .slop-btn.has-reports {
      border-color: var(--pink);
      color: var(--pink);
    }
    
    .slop-btn.reported {
      background: rgba(255,55,95,0.15);
      border-color: var(--pink);
      color: var(--pink);
    }

    .slop-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .robot-icon {
      height: 1.5rem;
      width: auto;
      vertical-align: middle;
      margin-right: 0.25rem;
    }

    .robot-icon-small {
      width: 14px;
      height: 14px;
      object-fit: contain;
      vertical-align: middle;
    }

    /* Slop Modal */
    .slop-modal .modal {
      max-width: 500px;
    }

    .slop-form textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 1rem;
    }

    .slop-form textarea:focus {
      outline: none;
      border-color: var(--pink);
    }

    .slop-form textarea::placeholder {
      color: var(--text-muted);
    }

    .slop-reports {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
    }

    .slop-report {
      padding: 0.75rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .slop-report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .slop-report-user {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--pink);
    }

    .slop-report-time {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .slop-report-reason {
      font-size: 0.85rem;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .slop-empty {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .delete-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 28px;
      height: 28px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .delete-btn:hover { background: var(--red); color: white; }
    }
    .delete-btn svg { width: 14px; height: 14px; }
    @media (hover: hover) {
      .post-card:hover .delete-btn { opacity: 1; }
    }

    .edit-categories-btn {
      position: absolute;
      top: 0.5rem;
      right: 2.5rem;
      width: 28px;
      height: 28px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
    }

    @media (hover: hover) {
      .edit-categories-btn:hover { background: var(--yellow); color: black; }
    }
    .edit-categories-btn svg { width: 14px; height: 14px; }
    @media (hover: hover) {
      .post-card:hover .edit-categories-btn { opacity: 1; }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal { transform: scale(1); }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 { font-size: 1.125rem; }

    .close-btn {
      width: 32px;
      height: 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .close-btn:hover { color: var(--text); border-color: var(--border-hover); }
    .close-btn svg { width: 16px; height: 16px; }

    .modal-body { padding: 1.5rem; }

    .input-group { margin-bottom: 1rem; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.5rem; }

    .input-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .input-group input:focus { outline: none; border-color: var(--purple); }
    .input-group input::placeholder { color: var(--text-muted); }

    .category-select {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .cat-checkbox { display: none; }

    .cat-label {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .cat-label:hover { border-color: rgba(255, 255, 255, 0.883); }

    .cat-checkbox:checked + .cat-label {
      border-color: var(--purple);
      background: linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%);
      color: var(--purple);
    }

    .cat-label[for="cat-art"] { --cat-color: var(--purple); --cat-bg: rgb(255, 239, 9); }
    .cat-label[for="cat-video"] { --cat-color: var(--red); --cat-bg: rgb(255, 239, 9); }
    .cat-label[for="cat-meme"] { --cat-color: var(--yellow); --cat-bg: rgb(255, 239, 9); }
    .cat-label[for="cat-tech"] { --cat-color: var(--cyan); --cat-bg: rgb(255, 239, 9); }
    .cat-label[for="cat-shitpost"] { --cat-color: var(--orange); --cat-bg: rgb(255, 239, 9); }
    .cat-label[for="cat-testnet"] { --cat-color: var(--green); --cat-bg: rgb(255, 239, 9); }

    .submit-btn {
      width: 100%;
      padding: 0.875rem;
      background: var(--accent-gradient);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .submit-btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .category-checkboxes {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .category-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
      font-size: 0.9rem;
    }

    .category-checkbox:hover {
      border-color: var(--yellow);
    }

    .category-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--yellow);
      cursor: pointer;
    }

    .category-checkbox:has(input:checked) {
      border-color: var(--yellow);
      background: rgba(234, 179, 8, 0.1);
    }

    .error-msg {
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
      font-size: 0.85rem;
      display: none;
    }

    .error-msg.visible { display: block; }

    .rating-no-posts {
      padding: 2rem 1.5rem;
      text-align: center;
    }

    .rating-no-posts p {
      color: var(--text-dim);
      margin-bottom: 1rem;
    }

    /* Vote Status Badge */
    .vote-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      height: 40px;
      padding: 0 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .vote-star {
      width: 14px;
      height: 14px;
      vertical-align: middle;
    }

    .vote-status.locked {
      border-color: var(--orange);
      color: var(--orange);
      cursor: pointer;
    }

    .vote-status.locked:hover {
      background: rgba(255,159,10,0.1);
    }

    .profile-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      max-width: 100%;
      height: 100vh;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      z-index: 1001;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .profile-panel.active { right: 0; }

    .profile-panel-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .profile-panel-header h2 { font-size: 1.125rem; }

    .profile-info {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .profile-info-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--accent);
    }

    .profile-info-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .profile-info-details h3 { font-size: 1rem; margin-bottom: 0.25rem; }
    .profile-info-details p { color: var(--text-dim); font-size: 0.9rem; }

    .profile-posts-header {
      padding: 1rem 1.5rem;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .profile-posts {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .profile-post {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .profile-post > img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      object-fit: cover;
      background: var(--bg);
    }

    .profile-post-info { flex: 1; min-width: 0; }
    .profile-post-info p { font-size: 0.85rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .profile-post-stats { font-size: 0.7rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; }
    .profile-post-stats span { display: flex; align-items: center; gap: 0.2rem; }
    .profile-stat-icon { width: 10px; height: 10px; object-fit: contain; }

    .logout-btn {
      margin: 1rem 1.5rem;
      padding: 0.75rem;
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover { background: var(--red); color: white; }

    .stats-btn {
      margin: 0 1.5rem 0.5rem;
      padding: 0.75rem;
      background: rgba(236, 184, 255, 1);
      border: 1px solid var(--purple);
      border-radius: 8px;
      color: var(--purple);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: calc(100% - 3rem);
    }

    .stats-btn:hover { background: var(--accent-gradient); border-color: transparent; color: white; }

    /* Stats Modal - New Design */
    .stats-modal {
      cursor: default;
      z-index: 1100;
    }
    
    .stats-modal .modal.stats-modal-content {
      max-width: 750px;
      padding: 2rem;
      position: relative;
      cursor: auto;
    }

    .stats-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    .stats-content {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }

    .stats-left {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .stats-pfp {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--bg-elevated);
      border: 3px solid var(--border);
    }

    .stats-pfp img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .stats-handle {
      font-size: 1.5rem;
      font-weight: 800;
      margin-top: 1rem;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    .stats-info {
      margin-top: 1.5rem;
    }

    .stats-info h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 0.75rem;
    }

    .stats-summary {
      display: flex;
      gap: 1.5rem;
    }

    .stat-item {
      text-align: left;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stats-right {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hexagon-container {
      position: relative;
      width: 300px;
      height: 300px;
    }

    .hexagon-chart {
      width: 100%;
      height: 100%;
    }

    .hex-label {
      position: absolute;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text);
      text-align: center;
      transform: translate(-50%, -50%);
    }

    .hex-label .grade {
      display: block;
      width: 32px;
      height: 32px;
      line-height: 30px;
      border: 2px solid var(--purple);
      border-radius: 50%;
      color: var(--purple);
      font-size: 0.75rem;
      font-weight: 700;
      margin: 0.3rem auto 0;
      background:linear-gradient(135deg, #EEC0FF 0%, #9B53B6 67%, #A249C4 100%);
    }

    .hex-label.ai .grade {
      width: auto;
      min-width: 40px;
      padding: 0 8px;
      border-color: var(--text);
      color: var(--text);
      font-size: 0.7rem;
      background: rgba(100, 16, 16, 0.8);
    }

    .stats-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .download-stats-btn {
      flex: 1;
      padding: 1rem;
      background: transparent;
      border: 2px solid var(--border);
      border-radius: 50px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .download-stats-btn:hover {
      border-color: var(--green);
      color: var(--green);
      background: var(--green-dim);
    }

    .download-stats-btn svg {
      width: 20px;
      height: 20px;
    }

    .share-x-btn {
      flex: 1;
      padding: 1rem;
      background: transparent;
      border: 2px solid var(--purple);
      border-radius: 50px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .share-x-btn:hover {
      background: var(--accent-gradient);
      border-color: transparent;
    }

    .share-x-btn svg {
      width: 22px;
      height: 22px;
    }

    @media (max-width: 650px) {
      .stats-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .stats-left {
        align-items: center;
      }
      
      .stats-info {
        text-align: center;
      }
      
      .stats-summary {
        justify-content: center;
      }
      
      .stat-item {
        text-align: center;
      }
      
      .hexagon-container {
        width: 260px;
        height: 260px;
      }
      
      .stats-buttons {
        flex-direction: column;
      }
      
      .download-stats-btn,
      .share-x-btn {
        font-size: 0.9rem;
        padding: 0.875rem;
      }
    }

    /* Profile Page Modal */
    .profile-modal .modal {
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .profile-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .profile-header-top {
      display: flex;
      gap: 1.25rem;
      align-items: flex-start;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--bg-elevated);
      flex-shrink: 0;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-main {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .profile-username {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .profile-bio {
      font-size: 0.9rem;
      color: var(--text-dim);
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }

    .profile-bio-edit {
      width: 100%;
      padding: 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      resize: none;
      margin-bottom: 0.5rem;
    }

    .profile-bio-edit:focus {
      outline: none;
      border-color: var(--purple);
    }

    .profile-stats-row {
      display: flex;
      gap: 1.5rem;
    }

    .profile-stat {
      cursor: pointer;
      transition: color 0.2s;
    }

    .profile-stat:hover {
      color: var(--purple);
    }

    .profile-stat-value {
      font-weight: 700;
      color: var(--text);
    }

    .profile-stat-label {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .profile-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .follow-btn {
      padding: 0.6rem 1.5rem;
      border-radius: 50px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .follow-btn.follow {
      background: var(--accent-gradient);
      border: none;
      color: white;
    }

    .follow-btn.follow:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .follow-btn.following {
      background: transparent;
      border: 2px solid var(--purple);
      color: var(--purple);
    }

    .follow-btn.following:hover {
      background: var(--red-dim);
      border-color: var(--red);
      color: var(--red);
    }

    .profile-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .profile-tab {
      flex: 1;
      padding: 0.875rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .profile-tab:hover {
      color: var(--text);
      background: var(--bg-elevated);
    }

    .profile-tab.active {
      color: var(--purple);
      border-bottom-color: var(--purple);
    }

    .profile-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .profile-posts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .profile-post-thumb {
      aspect-ratio: 1;
      background: var(--bg-elevated);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .profile-post-thumb:hover {
      transform: scale(1.02);
    }

    .profile-post-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-post-thumb .no-img {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    /* User list for followers/following */
    .user-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-elevated);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-card:hover {
      background: var(--bg-card);
    }

    .user-card-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--bg);
    }

    .user-card-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-card-info {
      flex: 1;
      min-width: 0;
    }

    .user-card-name {
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }

    .user-card-username {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .user-card .follow-btn {
      padding: 0.4rem 1rem;
      font-size: 0.8rem;
    }

    .empty-list {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    /* Following filter tab */
    .tab-btn.following-tab {
      display: none;
    }

    .tab-btn.following-tab.visible {
      display: block;
    }

    .panel-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .panel-backdrop.active { opacity: 1; visibility: visible; }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Rating Modal */
    .rating-modal .modal { max-width: 450px; }

    .rating-header {
      text-align: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .rating-icon {
      width: 48px;
      height: 48px;
      background: #141310;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }

    .rating-icon svg { width: 24px; height: 24px; color: white; }
    .rating-star-img { width: 28px; height: 28px; }
    .rating-header h2 { font-size: 1.125rem; margin-bottom: 0.25rem; }
    .rating-header p { font-size: 0.85rem; color: var(--text-dim); }

    .progress-bar {
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
      margin: 1rem 1.5rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-gradient);
      border-radius: 2px;
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .rating-card {
      margin: 0 1.5rem 1.5rem;
      background: var(--bg-elevated);
      border-radius: 12px;
      overflow: hidden;
    }

    .rating-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
    .rating-card-body { padding: 1rem; }
    .rating-card .post-author { margin-bottom: 0.75rem; }
    .rating-card .post-text { 
      font-size: 0.9rem; 
      margin-bottom: 1rem; 
      line-height: 1.6;
      max-height: 180px;
      overflow-y: auto;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .rating-readmore {
      display: inline-block;
      padding: 0.6rem 1.25rem;
      background: var(--accent-gradient);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .rating-readmore:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .rating-actions {
      display: flex;
      gap: 0.75rem;
      padding: 0 1.5rem 1.5rem;
    }

    .rate-btn {
      flex: 1;
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--bg-card);
      color: var(--text-dim);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.2s;
    }

    .rate-btn svg { width: 24px; height: 24px; }
    .rate-btn-icon { width: 24px; height: 24px; object-fit: contain; }
    .rate-btn.pass:hover { border-color: var(--red); color: var(--red); background: var(--red-dim); }
    .rate-btn.fire:hover { border-color: var(--green); color: var(--green); background: var(--green-dim); }

    /* Delete Confirmation Modal */
    .delete-confirm-modal {
      max-width: 360px;
      text-align: center;
      padding: 2rem;
    }

    .delete-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      background: var(--red-dim);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-icon svg {
      width: 28px;
      height: 28px;
      color: var(--red);
    }

    .delete-confirm-modal h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .delete-confirm-modal p {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .delete-modal-btns {
      display: flex;
      gap: 0.75rem;
    }

    .delete-cancel-btn, .delete-confirm-btn {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-cancel-btn {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .delete-cancel-btn:hover {
      background: var(--bg-card);
      border-color: var(--text-dim);
    }

    .delete-confirm-btn {
      background: var(--red);
      border: none;
      color: white;
    }

    .delete-confirm-btn:hover {
      background: #dc2626;
    }

    /* Scroll to Top Button */
    .scroll-top-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 48px;
      height: 48px;
      background: var(--accent-gradient);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .scroll-top-btn.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .scroll-top-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .scroll-top-btn:active {
      transform: translateY(0);
    }

    .scroll-top-btn svg {
      width: 24px;
      height: 24px;
    }

    @media (max-width: 500px) {
      .scroll-top-btn {
        width: 42px;
        height: 42px;
        bottom: 1.5rem;
        right: 1.5rem;
      }
      
      .scroll-top-btn svg {
        width: 20px;
        height: 20px;
      }
    }

    /* Grid Toggle Button - Mobile Only */
    .grid-toggle-btn {
      position: fixed;
      bottom: 2rem;
      left: 2rem;
      width: 48px;
      height: 48px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--text);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    .grid-toggle-btn:hover {
      border-color: var(--border-hover);
      transform: scale(1.05);
    }

    .grid-toggle-btn svg {
      width: 22px;
      height: 22px;
    }

    .grid-toggle-btn .grid-count {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 20px;
      height: 20px;
      background: var(--accent-gradient);
      border-radius: 50%;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 500px) {
      .grid-toggle-btn {
        display: flex;
        width: 42px;
        height: 42px;
        bottom: 1.5rem;
        left: 1.5rem;
      }
      
      .grid-toggle-btn svg {
        width: 18px;
        height: 18px;
      }
      
      .grid-toggle-btn .grid-count {
        width: 18px;
        height: 18px;
        font-size: 0.65rem;
      }
      
      /* Grid mode overrides for mobile */
      .grid.grid-1col { columns: 1 !important; }
      .grid.grid-2col { columns: 2 !important; column-gap: 0.4rem !important; }
      
      /* Smaller cards in 2-column mode */
      .grid.grid-2col .post-card {
        margin-bottom: 0.4rem;
      }
      
      .grid.grid-2col .post-body {
        padding: 0.5rem;
      }
      
      .grid.grid-2col .post-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        margin-bottom: 0.4rem;
      }
      
      .grid.grid-2col .post-text {
        font-size: 0.75rem;
        margin-bottom: 0.4rem;
        -webkit-line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .grid.grid-2col .post-footer {
        padding-top: 0.4rem;
      }
      
      .grid.grid-2col .post-footer-left {
        gap: 0.4rem;
      }
      
      /* Hide X View link in 2-column mode */
      .grid.grid-2col .twitter-link {
        display: none;
      }
      
      .grid.grid-2col .vote-btns {
        gap: 0.25rem;
      }
      
      .grid.grid-2col .vote-btn {
        padding: 0.2rem 0.35rem;
        font-size: 0.65rem;
        gap: 0.15rem;
      }
      
      .grid.grid-2col .vote-btn svg {
        width: 10px;
        height: 10px;
      }
      
      .grid.grid-2col .slop-btn {
        padding: 0.2rem 0.3rem;
        font-size: 0.6rem;
      }
      
      .grid.grid-2col .robot-icon-small {
        width: 10px;
        height: 10px;
      }
      
      .grid.grid-2col .author-avatar {
        width: 22px;
        height: 22px;
      }
      
      .grid.grid-2col .author-handle {
        font-size: 0.7rem;
        max-width: 70px;
      }
      
      .grid.grid-2col .cat-badge {
        font-size: 0.5rem;
        padding: 0.1rem 0.25rem;
      }
      
      .grid.grid-2col .post-categories {
        gap: 0.15rem;
      }
      
      .grid.grid-2col .post-time {
        font-size: 0.6rem;
      }
      
      /* 1-column adjustments for mobile */
      .grid.grid-1col .cat-badge {
        font-size: 0.55rem;
        padding: 0.15rem 0.35rem;
      }
      
      .grid.grid-1col .vote-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .grid.grid-1col .slop-btn {
        padding: 0.3rem 0.4rem;
        font-size: 0.65rem;
      }
      
      /* Reduce main padding on mobile */
      .main {
        padding: 1rem 0.5rem;
      }
    }

    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.875rem 1.25rem;
      background: var(--bg-card);
      border: 1px solid var(--green);
      border-radius: 10px;
      color: var(--text);
      font-size: 0.9rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.visible { transform: translateY(0); opacity: 1; }
    .hidden { display: none !important; }

    /* Post Detail Modal */
    .post-modal .modal {
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .post-modal-image {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      background: #000;
    }

    .post-modal-body {
      padding: 1.25rem;
      overflow-y: auto;
      flex: 1;
    }

    .post-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .post-modal-author {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }

    .post-modal-author:hover .post-modal-handle {
      color: var(--text);
    }

    .post-modal-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--bg-elevated);
    }

    .post-modal-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-modal-handle {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-dim);
    }

    .post-modal-categories {
      display: flex;
      gap: 0.35rem;
    }

    .post-modal-text {
      font-size: 1rem;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 1rem;
    }

    .post-modal-readmore {
      display: inline-block;
      padding: 0.75rem 1.25rem;
      background: var(--accent-gradient);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      transition: opacity 0.2s;
    }

    .post-modal-readmore:hover {
      opacity: 0.9;
    }

    .post-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      margin-top: 1rem;
    }

    .post-modal-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 700px) {
      .header {
        padding: 0.75rem 0.75rem;
        transition: padding 0.3s ease;
      }
      
      /* Default mobile layout - show everything */
      .header-inner { 
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-areas: 
          "logo login"
          "search search"
          "actions actions";
        gap: 0.75rem;
        align-items: center;
        transition: gap 0.3s ease;
      }
      
      /* Logo - top left */
      .logo {
        grid-area: logo;
        justify-self: start;
      }
      
      /* Login/Profile button - top right */
      .header-actions {
        grid-area: actions;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: flex-start;
      }
      
      /* Show mobile tabs */
      .mobile-tabs {
        display: flex !important;
      }
      
      /* Push trophy to right */
      .header-actions .leaderboard-btn {
        margin-left: auto;
      }
      
      .header-actions .login-btn,
      .header-actions .profile-btn {
        position: absolute;
        top: 0;
        right: 0;
      }
      
      .header-actions .vote-status {
        position: absolute;
        top: 0;
        right: 50px;
      }
      
      /* Search - full width */
      .search-container {
        grid-area: search;
        width: 100%;
        max-width: none;
        margin: 0;
      }
      
      /* Activity ticker */
      .activity-ticker {
        margin-top: 0.5rem;
        padding: 0;
        transition: opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease;
        max-height: 100px;
        overflow: hidden;
      }
      
      /* Header bottom with category filters - centered */
      .header-bottom {
        flex-direction: row;
        justify-content: center;
        padding: 0;
        margin-top: 0.5rem;
        overflow-x: visible;
        transition: margin 0.3s ease;
      }
      
      /* Hide desktop tab btns from header-bottom on mobile */
      .header-bottom .tab-btns {
        display: none;
      }
      
      .category-filters { 
        flex-wrap: nowrap;
        justify-content: center;
        gap: 0.4rem;
        width: 100%;
      }
      
      .cat-filter {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 20px;
      }
      
      /* ===== COLLAPSED HEADER STATE (when scrolling) ===== */
      .header.collapsed {
        padding: 0.5rem 0.75rem;
      }
      
      .header.collapsed .header-inner {
        grid-template-areas: 
          "logo login"
          "search search";
        gap: 0.5rem;
      }
      
      .header.collapsed .header-actions {
        grid-area: login;
        width: auto;
        justify-content: flex-end;
      }
      
      /* Hide these when collapsed */
      .header.collapsed .activity-ticker {
        opacity: 0;
        max-height: 0;
        margin: 0;
        pointer-events: none;
      }
      
      .header.collapsed .header-actions .mobile-tabs,
      .header.collapsed .header-actions .leaderboard-btn,
      .header.collapsed .header-actions .share-btn,
      .header.collapsed .header-actions .vote-status {
        display: none !important;
      }
      
      .header.collapsed .header-actions .login-btn,
      .header.collapsed .header-actions .profile-btn {
        position: static;
      }
      
      .header.collapsed .header-bottom {
        margin-top: 0.5rem;
      }
    }
    
    @media (max-width: 500px) {
      .header {
        padding: 0.5rem 0.5rem;
      }
      
      .header.collapsed {
        padding: 0.5rem 0.5rem;
      }
      
      .header-actions .login-btn,
      .header-actions .profile-btn {
        top: 0;
        right: 0;
      }
      
      .header-actions .vote-status {
        top: 0;
        right: 42px;
      }
      
      .logo-img {
        height: 28px;
      }
      
      .share-btn {
        padding: 0 0.6rem;
        font-size: 0.75rem;
        height: 34px;
      }
      
      .login-btn {
        padding: 0 0.6rem;
        font-size: 0.75rem;
        height: 34px;
      }
      
      .leaderboard-btn {
        width: 34px;
        height: 34px;
      }
      
      .leaderboard-trophy {
        width: 18px;
        height: 18px;
      }
      
      .profile-btn {
        width: 34px;
        height: 34px;
      }
      
      .vote-status {
        font-size: 0.65rem;
        padding: 0 0.4rem;
        height: 34px;
      }
      
      .category-filters {
        gap: 0.25rem;
      }
      
      .cat-filter {
        padding: 0.3rem 0.4rem;
        font-size: 0.65rem;
      }
      
      .tab-btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
      }
      
      .tab-btns {
        padding: 3px;
      }
      
      .header-actions {
        gap: 0.35rem;
      }
      
      .activity-ticker {
        margin-top: 0.35rem;
      }
      
      .header-bottom {
        margin-top: 0.35rem;
        gap: 0.35rem;
      }
      
      /* Post card adjustments for mobile */
      .post-header {
        flex-wrap: wrap;
      }
      
      .post-categories {
        gap: 0.2rem;
      }
      
      .cat-badge {
        font-size: 0.55rem;
        padding: 0.15rem 0.35rem;
      }
      
      .vote-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .vote-btn svg {
        width: 12px;
        height: 12px;
      }
      
      .slop-btn {
        padding: 0.3rem 0.4rem;
        font-size: 0.65rem;
      }
      
      .robot-icon-small {
        width: 12px;
        height: 12px;
      }
      
      .post-body {
        padding: 0.75rem;
      }
      
      .post-text {
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
      }
      
      .author-handle {
        max-width: 100px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="#" class="logo" onclick="location.reload()">
        <img src="assets/magicblob.png" alt="Magicblob" class="logo-img">
      </a>

      <!-- Search Bar - stretched -->
      <div class="search-container">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search @handle...">
        <button class="search-clear" id="searchClear">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="header-actions">
        <div class="tab-btns mobile-tabs">
          <button class="tab-btn" data-tab="trending">Trending</button>
          <button class="tab-btn active" data-tab="new">New</button>
          <button class="tab-btn" data-tab="7d">7D</button>
          <button class="tab-btn following-tab" data-tab="following" id="mobileFollowingTab">Following</button>
        </div>

        <a href="leaderboard.html" class="leaderboard-btn" title="Weekly Leaderboard">
          <img src="assets/trophy.png" alt="Leaderboard" class="leaderboard-trophy">
        </a>

        <button class="share-btn" id="openShare">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Share
        </button>

        <button class="login-btn" id="loginBtn">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          Login
        </button>

        <!-- Vote Status (shown when logged in) -->
        <div class="vote-status hidden" id="voteStatus" onclick="onVoteStatusClick()">
          <span id="voteStatusText"> Rate 3 posts</span>
        </div>

        <button class="profile-btn hidden" id="profileBtn">
          <img id="profileBtnImg" src="" alt="Profile">
        </button>
      </div>
    </div>

    <!-- Activity Ticker -->
    <div class="activity-ticker" id="activityTicker">
      <div class="ticker-wrapper">
        <div class="ticker-track" id="tickerTrack">
          <span class="ticker-empty">Loading recent activity...</span>
        </div>
      </div>
    </div>

    <!-- Tabs and Categories Row -->
    <div class="header-bottom">
      <div class="category-filters">
        <button class="cat-filter" data-cat="art"><span class="cat-dot"></span> Art</button>
        <button class="cat-filter" data-cat="video"><span class="cat-dot"></span> Video</button>
        <button class="cat-filter" data-cat="meme"><span class="cat-dot"></span> Meme</button>
        <button class="cat-filter" data-cat="tech"><span class="cat-dot"></span> Tech</button>
        <button class="cat-filter" data-cat="shitpost"><span class="cat-dot"></span> Shitpost</button>
        <button class="cat-filter" data-cat="testnet"><span class="cat-dot"></span> Events</button>
      </div>
      <div class="tab-btns">
        <button class="tab-btn" data-tab="trending">Trending</button>
        <button class="tab-btn active" data-tab="new">New</button>
        <button class="tab-btn" data-tab="7d">7D</button>
        <button class="tab-btn following-tab" data-tab="following" id="followingTab">Following</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading">Loading posts...</div>
    
    <div class="empty-state hidden" id="emptyState">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
      </div>
      <h2>No posts yet</h2>
      <p>Be the first to share a Twitter/X post!</p>
      <button class="share-btn" id="emptyShare">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Share Post
      </button>
    </div>

    <div class="grid hidden" id="grid"></div>
  </main>

  <!-- Scroll to Top Button -->
  <button class="scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <polyline points="18 15 12 9 6 15"/>
    </svg>
  </button>

  <!-- Grid Toggle Button - Mobile Only -->
  <button class="grid-toggle-btn" id="gridToggleBtn" onclick="toggleGridMode()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
    </svg>
    <span class="grid-count" id="gridCount">1</span>
  </button>

  <!-- Share Modal -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Share a Tweet</h2>
        <button class="close-btn" id="closeShare">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="shareForm">
          <div class="input-group">
            <label>Twitter/X URL</label>
            <input type="url" id="urlInput" placeholder="https://x.com/user/status/123..." required>
          </div>
          <div class="input-group">
            <label>Categories (select at least 1)</label>
            <div class="category-select">
              <input type="checkbox" class="cat-checkbox" id="cat-art" value="art">
              <label class="cat-label" for="cat-art">Art</label>
              <input type="checkbox" class="cat-checkbox" id="cat-video" value="video">
              <label class="cat-label" for="cat-video">Video</label>
              <input type="checkbox" class="cat-checkbox" id="cat-meme" value="meme">
              <label class="cat-label" for="cat-meme">Meme</label>
              <input type="checkbox" class="cat-checkbox" id="cat-tech" value="tech">
              <label class="cat-label" for="cat-tech">Tech</label>
              <input type="checkbox" class="cat-checkbox" id="cat-shitpost" value="shitpost">
              <label class="cat-label" for="cat-shitpost">Shitpost</label>
              <input type="checkbox" class="cat-checkbox" id="cat-testnet" value="testnet">
              <label class="cat-label" for="cat-testnet">Events</label>
            </div>
          </div>
          <button type="submit" class="submit-btn" id="submitBtn">
            <span id="submitText">Fetch & Share</span>
          </button>
          <div class="error-msg" id="errorMsg"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal-overlay rating-modal" id="ratingModal">
    <div class="modal">
      <div class="rating-header">
        <div class="rating-icon">
          <img src="assets/point.png" alt="Star" class="rating-star-img">
        </div>
        <h2>Daily Rating</h2>
        <p id="ratingSubtitle">Rate 3 posts to unlock 20 votes today</p>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <p class="progress-text"><span id="ratedCount">0</span>/<span id="ratingTotal">3</span> rated</p>
      <div class="rating-card" id="ratingCard">
        <img id="ratingImg" src="" alt="">
        <div class="rating-card-body">
          <div class="post-author">
            <div class="author-avatar" id="ratingAvatarContainer">
              <img id="ratingAvatarImg" src="" alt="" class="hidden">
              <span id="ratingAvatarLetter">?</span>
            </div>
            <span class="author-handle" id="ratingHandle">@user</span>
          </div>
          <p class="post-text" id="ratingText">Loading...</p>
          <a href="#" target="_blank" class="rating-readmore" id="ratingReadMore">
            Read full post on X 
          </a>
        </div>
      </div>
      <div class="rating-no-posts hidden" id="ratingNoPosts">
        <p>No more posts to rate! You've rated all available posts.</p>
        <button class="submit-btn" onclick="document.getElementById('ratingModal').classList.remove('active')">Close</button>
      </div>
      <div class="rating-actions" id="ratingActions">
        <button class="rate-btn pass" id="ratePass">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
          Pass
        </button>
        <button class="rate-btn fire" id="rateFire">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="18 15 12 9 6 15"/>
          </svg>
          Fire
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay delete-modal" id="deleteModal">
    <div class="modal delete-confirm-modal">
      <div class="delete-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          <line x1="10" y1="11" x2="10" y2="17"/>
          <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
      </div>
      <h3>Delete Post</h3>
      <p>Are you sure you want to delete this post? This action cannot be undone.</p>
      <div class="delete-modal-btns">
        <button class="delete-cancel-btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="delete-confirm-btn" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- AI Slop Modal -->
  <div class="modal-overlay slop-modal" id="slopModal">
    <div class="modal">
      <div class="modal-header">
        <h2><img src="assets/robot.png" alt="" class="robot-icon"> Slop Report</h2>
        <button class="close-btn" onclick="closeSlopModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Own post message -->
        <div id="slopOwnPost" class="hidden" style="padding: 1rem; background: rgba(110, 23, 66, 1); border-radius: 8px; margin-bottom: 1rem;">
          <p style="color: var(--accent); font-size: 0.9rem;"> This is your post  you can view reports but can't report it</p>
        </div>
        
        <!-- Report form (shown if user hasn't reported) -->
        <div id="slopFormSection" class="hidden">
          <p style="color: var(--text-dim); margin-bottom: 1rem; font-size: 0.9rem;">
            Think this post is AI-generated slop? Explain why:
          </p>
          <div class="slop-form">
            <textarea id="slopReason" placeholder="e.g., Generic AI art style, repetitive patterns, unnatural composition..." maxlength="500"></textarea>
            <button class="submit-btn" id="submitSlop" style="background: var(--pink);">
              Report as AI Slop
            </button>
          </div>
        </div>
        
        <!-- Already reported message -->
        <div id="slopAlreadyReported" class="hidden" style="padding: 1rem; background: rgba(255,55,95,0.1); border-radius: 8px; margin-bottom: 1rem;">
          <p style="color: var(--pink); font-size: 0.9rem;"> You've already reported this post</p>
        </div>
        
        <!-- Reports list -->
        <div id="slopReportsSection">
          <h3 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Reports (<span id="slopCount">0</span>)
          </h3>
          <div class="slop-reports" id="slopReportsList">
            <div class="slop-empty">No reports yet</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Categories Modal (Admin) -->
  <div class="modal-overlay" id="editCategoriesModal">
    <div class="modal">
      <div class="modal-header">
        <h2> Edit Categories</h2>
        <button class="close-btn" onclick="closeEditCategoriesModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-dim); margin-bottom: 1rem; font-size: 0.9rem;">
          Select categories for this post (Admin only):
        </p>
        <div class="category-checkboxes" id="editCategoryCheckboxes">
          <label class="category-checkbox">
            <input type="checkbox" value="art"> Art
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="video"> Video
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="meme"> Meme
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="tech"> Tech
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="shitpost"> Shitpost
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="testnet"> Events
          </label>
        </div>
        <button class="submit-btn" id="saveCategories" style="margin-top: 1rem;">
          Save Categories
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Panel -->
  <div class="panel-backdrop" id="panelBackdrop"></div>
  <div class="profile-panel" id="profilePanel">
    <div class="profile-panel-header">
      <h2>Your Profile</h2>
      <button class="close-btn" id="closePanel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="profile-info">
      <div class="profile-info-avatar">
        <img id="panelPfp" src="" alt="">
      </div>
      <div class="profile-info-details">
        <h3 id="panelName">Loading...</h3>
        <p id="panelUsername">@username</p>
      </div>
    </div>
    <div class="profile-posts-header">Your Posts</div>
    <div class="profile-posts" id="profilePosts">
      <p style="color: var(--text-muted); text-align: center; padding: 2rem;">No posts yet</p>
    </div>
    <button class="stats-btn" id="statsBtn"> View Statistics</button>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>

  <!-- Stats Modal -->
  <div class="modal-overlay stats-modal" id="statsModal">
    <div class="modal stats-modal-content">
      <button class="close-btn stats-close" onclick="document.getElementById('statsModal').classList.remove('active')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      
      <div class="stats-content" id="statsContent">
        <div class="stats-left">
          <div class="stats-pfp">
            <img id="statsPfp" src="" alt="">
          </div>
          <h2 class="stats-handle" id="statsHandle">@username</h2>
          
          <div class="stats-info">
            <h3>Your Statistics</h3>
            <div class="stats-summary">
              <div class="stat-item">
                <div class="stat-value" id="statTotalPosts">0</div>
                <div class="stat-label">POSTS</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="statTotalLikes">0</div>
                <div class="stat-label">LIKES</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="statTotalSlop">0</div>
                <div class="stat-label">AI REPORTS</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="stats-right">
          <div class="hexagon-container">
            <svg class="hexagon-chart" viewBox="0 0 200 200" id="hexChart">
              <!-- Background hexagons (grid) -->
              <polygon class="hex-bg" points="" fill="none" stroke="rgba(186, 0, 255, 1)" stroke-width="1"/>
              <polygon class="hex-bg" points="" fill="none" stroke="rgba(186, 0, 255, 1)" stroke-width="1"/>
              <polygon class="hex-bg" points="" fill="none" stroke="rgba(186, 0, 255, 1)" stroke-width="1"/>
              <!-- Data polygon -->
              <polygon id="hexData" points="" fill="rgba(228, 156, 255, 1)" stroke="var(--purple)" stroke-width="2"/>
            </svg>
            <!-- Labels positioned around hexagon -->
            <div class="hex-label" style="top: 2%; left: 50%;" id="labelArt">
              Art
              <span class="grade" id="gradeArt">-</span>
            </div>
            <div class="hex-label" style="top: 22%; left: 95%;" id="labelVideo">
              Video
              <span class="grade" id="gradeVideo">-</span>
            </div>
            <div class="hex-label" style="top: 78%; left: 95%;" id="labelMeme">
              Meme
              <span class="grade" id="gradeMeme">-</span>
            </div>
            <div class="hex-label" style="top: 98%; left: 50%;" id="labelTech">
              Tech
              <span class="grade" id="gradeTech">-</span>
            </div>
            <div class="hex-label" style="top: 78%; left: 5%;" id="labelShitpost">
              Shitpost
              <span class="grade" id="gradeShitpost">-</span>
            </div>
            <div class="hex-label" style="top: 22%; left: 5%;" id="labelTestnet">
              Events
              <span class="grade" id="gradeTestnet">-</span>
            </div>
            <div class="hex-label ai" style="top: 50%; left: 50%;" id="labelAI">
              AI Slop
              <span class="grade" id="gradeAI">0%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="stats-buttons">
        <button class="download-stats-btn" id="downloadStatsBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </button>
        <button class="share-x-btn" id="shareXBtn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          Share on X
        </button>
      </div>
    </div>
  </div>

  <!-- Post Detail Modal -->
  <div class="modal-overlay post-modal" id="postModal">
    <div class="modal">
      <button class="close-btn" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;" onclick="closePostModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <img class="post-modal-image" id="postModalImage" src="" alt="">
      <div class="post-modal-body">
        <div class="post-modal-header">
          <div class="post-modal-author" id="postModalAuthor">
            <div class="post-modal-avatar">
              <img id="postModalAvatar" src="" alt="">
            </div>
            <span class="post-modal-handle" id="postModalHandle">@user</span>
          </div>
          <div class="post-modal-categories" id="postModalCategories"></div>
        </div>
        <p class="post-modal-text" id="postModalText"></p>
        <a href="#" target="_blank" class="post-modal-readmore" id="postModalReadMore">
          Read more on X 
        </a>
        <div class="post-modal-footer">
          <span class="post-modal-time" id="postModalTime"></span>
          <div class="vote-btns" id="postModalVotes"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div class="modal-overlay profile-modal" id="userProfileModal">
    <div class="modal">
      <button class="close-btn" style="position: absolute; top: 1rem; right: 1rem;" onclick="closeProfileModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      
      <div class="profile-header">
        <div class="profile-header-top">
          <div class="profile-avatar">
            <img id="profileModalPfp" src="" alt="">
          </div>
          <div class="profile-main">
            <h2 class="profile-name" id="profileModalName">User Name</h2>
            <p class="profile-username" id="profileModalUsername">@username</p>
            <p class="profile-bio" id="profileModalBio"></p>
            <div class="profile-stats-row">
              <span class="profile-stat" onclick="showProfileFollowers()">
                <span class="profile-stat-value" id="profileModalFollowers">0</span>
                <span class="profile-stat-label">Followers</span>
              </span>
              <span class="profile-stat" onclick="showProfileFollowing()">
                <span class="profile-stat-value" id="profileModalFollowing">0</span>
                <span class="profile-stat-label">Following</span>
              </span>
              <span class="profile-stat">
                <span class="profile-stat-value" id="profileModalPosts">0</span>
                <span class="profile-stat-label">Posts</span>
              </span>
            </div>
            <div class="profile-actions" id="profileActions">
              <button class="follow-btn follow" id="profileFollowBtn" onclick="toggleFollow()">Follow</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-tabs">
        <button class="profile-tab active" data-ptab="posts" onclick="switchProfileTab('posts')">Posts</button>
        <button class="profile-tab" data-ptab="followers" onclick="switchProfileTab('followers')">Followers</button>
        <button class="profile-tab" data-ptab="following" onclick="switchProfileTab('following')">Following</button>
      </div>
      
      <div class="profile-content" id="profileContent">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Post shared!</div>

  <script>
    const API_URL = "https://api.magicblobs.xyz"

    // State
    let posts = [];
    let votes = {}; // user's votes: { post_id: 'up' | 'down' }
    let activeTab = 'new';
    let activeCategories = [];
    let searchQuery = '';
    let currentUser = null;
    let authToken = localStorage.getItem('postflow_token');
    let followingPosts = []; // Posts from followed users
    let followingUserIds = new Set(); // IDs of users current user follows
    
    // Profile modal state
    let currentProfileUser = null;
    let currentProfileTab = 'posts';
    
    // Vote status (from server)
    let voteStatus = {
      can_vote: false,
      votes_remaining: 0,
      votes_today: 0,
      ratings_today: 0,
      ratings_needed: 3,
      daily_limit: 20,
      required_ratings: 3
    };
    
    // Rating queue
    let ratingQueue = [];
    let ratingIndex = 0;

    // DOM
    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('emptyState');
    const loading = document.getElementById('loading');
    const shareModal = document.getElementById('shareModal');
    const ratingModal = document.getElementById('ratingModal');
    const toast = document.getElementById('toast');
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profilePanel = document.getElementById('profilePanel');
    const panelBackdrop = document.getElementById('panelBackdrop');

    // Check for auth token in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('token')) {
      authToken = urlParams.get('token');
      localStorage.setItem('postflow_token', authToken);
      window.history.replaceState({}, '', window.location.pathname);
    }
    if (urlParams.get('error')) {
      alert('Login failed: ' + urlParams.get('error'));
      window.history.replaceState({}, '', window.location.pathname);
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // API calls
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }
    
    function timeAgo(dateString) {
      if (!dateString) return '';
      
      const now = new Date();
      // Parse the date string and treat it as UTC if no timezone specified
      let date;
      if (dateString.includes('Z') || dateString.includes('+')) {
        date = new Date(dateString);
      } else {
        // SQLite returns datetime without timezone, assume UTC
        date = new Date(dateString + 'Z');
      }
      
      const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
      
      if (seconds < 0) return 'just now'; // Future date protection
      if (seconds < 60) return 'just now';
      
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      
      const weeks = Math.floor(days / 7);
      if (weeks < 4) return `${weeks}w ago`;
      
      const months = Math.floor(days / 30);
      if (months < 12) return `${months}mo ago`;
      
      const years = Math.floor(days / 365);
      return `${years}y ago`;
    }

    async function fetchPosts() {
      try {
        posts = await api('/posts');
        renderGrid();
        renderTicker();
        if (currentUser) {
          updateProfilePosts(); // Update profile posts after posts are loaded
        }
      } catch (err) {
        console.error('Failed to fetch posts:', err);
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function fetchUserVotes() {
      if (!authToken) return;
      try {
        votes = await api('/user/votes');
        renderGrid();
      } catch (err) {
        console.error('Failed to fetch votes:', err);
      }
    }

    async function fetchUser() {
      if (!authToken) return;
      try {
        currentUser = await api('/auth/me');
        
        // Update vote status from server
        voteStatus = {
          can_vote: currentUser.can_vote || false,
          votes_remaining: currentUser.votes_remaining || 0,
          votes_today: currentUser.votes_today || 0,
          ratings_today: currentUser.ratings_today || 0,
          ratings_needed: currentUser.ratings_needed || 3,
          daily_limit: currentUser.daily_limit || 20,
          required_ratings: currentUser.required_ratings || 3
        };
        
        updateAuthUI();
        
        // Show rating modal if user needs to rate posts today
        if (currentUser && !voteStatus.can_vote && posts.length >= 3) {
          showRatingModal();
        }
      } catch (err) {
        localStorage.removeItem('postflow_token');
        authToken = null;
      }
    }

    async function showRatingModal() {
      try {
        const data = await api('/rating/posts');
        ratingQueue = data.posts || [];
        
        if (ratingQueue.length === 0) {
          // No posts to rate (user has rated all posts) - don't show modal
          return;
        }
        
        // Show rating card
        document.getElementById('ratingCard').classList.remove('hidden');
        document.getElementById('ratingActions').classList.remove('hidden');
        document.getElementById('ratingNoPosts').classList.add('hidden');
        
        // Update UI
        document.getElementById('ratingTotal').textContent = voteStatus.required_ratings;
        document.getElementById('ratedCount').textContent = voteStatus.ratings_today;
        document.getElementById('progressFill').style.width = (voteStatus.ratings_today / voteStatus.required_ratings * 100) + '%';
        document.getElementById('ratingSubtitle').textContent = 
          `Rate ${voteStatus.ratings_needed} posts to unlock ${voteStatus.daily_limit} votes today`;
        
        ratingIndex = 0;
        updateRatingCard();
        ratingModal.classList.add('active');
      } catch (err) {
        console.error('Failed to load rating posts:', err);
      }
    }

    function updateRatingCard() {
      const post = ratingQueue[ratingIndex];
      if (!post) return;
      
      const img = document.getElementById('ratingImg');
      img.src = post.image || '';
      img.style.display = post.image ? 'block' : 'none';
      
      const avatarImg = document.getElementById('ratingAvatarImg');
      const avatarLetter = document.getElementById('ratingAvatarLetter');
      
      if (post.author_pfp) {
        avatarImg.src = post.author_pfp;
        avatarImg.classList.remove('hidden');
        avatarLetter.classList.add('hidden');
      } else {
        avatarImg.classList.add('hidden');
        avatarLetter.classList.remove('hidden');
        avatarLetter.textContent = (post.author || '?').replace('@', '').charAt(0).toUpperCase();
      }
      
      document.getElementById('ratingHandle').textContent = post.author || 'Unknown';
      
      // Show up to 500 characters of text
      const fullText = post.text || 'No text';
      const truncatedText = fullText.length > 500 
        ? fullText.substring(0, 500) + '...' 
        : fullText;
      document.getElementById('ratingText').textContent = truncatedText;
      
      // Set read more link
      document.getElementById('ratingReadMore').href = post.url || '#';
    }

    async function handleRating(type) {
      const post = ratingQueue[ratingIndex];
      if (!post) return;
      
      try {
        const result = await api('/rating/submit', {
          method: 'POST',
          body: JSON.stringify({ post_id: post.id, type: type === 'fire' ? 'up' : 'down' })
        });
        
        // Update vote status
        voteStatus = {
          can_vote: result.can_vote,
          votes_remaining: result.votes_remaining,
          votes_today: result.votes_today,
          ratings_today: result.ratings_today,
          ratings_needed: result.ratings_needed,
          daily_limit: result.daily_limit,
          required_ratings: result.required_ratings
        };
        
        // Update progress
        document.getElementById('ratedCount').textContent = voteStatus.ratings_today;
        document.getElementById('progressFill').style.width = (voteStatus.ratings_today / voteStatus.required_ratings * 100) + '%';
        
        // Also update the post in our local array
        const localPost = posts.find(p => p.id === post.id);
        if (localPost) {
          if (type === 'fire') localPost.likes++;
          else localPost.dislikes++;
        }
        votes[post.id] = type === 'fire' ? 'up' : 'down';
        
        if (voteStatus.can_vote) {
          ratingModal.classList.remove('active');
          showToast(` Voting unlocked! You have ${voteStatus.votes_remaining} votes today`);
          updateAuthUI(); // Update the header button
          renderGrid();
        } else {
          ratingIndex++;
          if (ratingIndex < ratingQueue.length) {
            updateRatingCard();
          } else {
            // No more posts in queue, fetch more or show complete
            ratingModal.classList.remove('active');
            showToast('Rated all available posts!');
            updateAuthUI(); // Update the header button
          }
        }
      } catch (err) {
        showToast(err.message);
      }
    }

    function updateAuthUI() {
      const voteStatusEl = document.getElementById('voteStatus');
      const voteStatusText = document.getElementById('voteStatusText');
      const followingTab = document.getElementById('followingTab');
      const mobileFollowingTab = document.getElementById('mobileFollowingTab');
      
      if (currentUser) {
        loginBtn.classList.add('hidden');
        profileBtn.classList.remove('hidden');
        voteStatusEl.classList.remove('hidden');
        followingTab.classList.add('visible'); // Show Following tab
        if (mobileFollowingTab) mobileFollowingTab.classList.add('visible'); // Show mobile Following tab
        document.getElementById('profileBtnImg').src = currentUser.pfp || '';
        document.getElementById('panelPfp').src = currentUser.pfp || '';
        document.getElementById('panelName').textContent = currentUser.name || currentUser.username;
        document.getElementById('panelUsername').textContent = '@' + currentUser.username;
        updateProfilePosts();
        fetchFollowingFeed(); // Fetch posts from followed users
        
        // Update vote status display
        if (voteStatus.can_vote) {
          voteStatusEl.classList.remove('locked');
          voteStatusText.innerHTML = `<img src="assets/point.png" class="vote-star"> ${voteStatus.votes_remaining}/${voteStatus.daily_limit} votes`;
        } else {
          voteStatusEl.classList.add('locked');
          voteStatusText.textContent = ` Rate ${voteStatus.ratings_needed} posts`;
        }
      } else {
        loginBtn.classList.remove('hidden');
        profileBtn.classList.add('hidden');
        voteStatusEl.classList.add('hidden');
        followingTab.classList.remove('visible'); // Hide Following tab
        if (mobileFollowingTab) mobileFollowingTab.classList.remove('visible'); // Hide mobile Following tab
      }
    }
    
    async function fetchFollowingFeed() {
      if (!currentUser) return;
      try {
        followingPosts = await api('/feed/following');
        // Also get list of who current user follows
        const following = await api(`/users/${currentUser.username}/following`);
        followingUserIds = new Set(following.map(u => u.id));
        if (activeTab === 'following') {
          renderGrid();
        }
      } catch (err) {
        console.error('Failed to fetch following feed:', err);
      }
    }
    
    function onVoteStatusClick() {
      if (!voteStatus.can_vote) {
        showRatingModal();
      }
    }

    function updateProfilePosts() {
      const container = document.getElementById('profilePosts');
      const userPosts = posts.filter(p => p.user_id === currentUser?.id);
      
      if (userPosts.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No posts yet</p>';
        return;
      }
      
      container.innerHTML = userPosts.map(post => `
        <div class="profile-post">
          <img src="${post.image || ''}" alt="" onerror="this.style.background='var(--bg)'">
          <div class="profile-post-info">
            <p>${post.text || 'No text'}</p>
            <div class="profile-post-stats">
              <span><img src="assets/like.png" alt="Likes" class="profile-stat-icon"> ${post.likes}</span>
              <span><img src="assets/dislike.png" alt="Dislikes" class="profile-stat-icon"> ${post.dislikes}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderTicker() {
      const tickerTrack = document.getElementById('tickerTrack');
      
      // Get last 15 posts
      const recentPosts = posts.slice(0, 15);
      
      if (recentPosts.length === 0) {
        tickerTrack.innerHTML = '<span class="ticker-empty">No activity yet  be the first to share!</span>';
        tickerTrack.style.animation = 'none';
        return;
      }
      
      // Create ticker items
      const tickerItems = recentPosts.map(post => {
        const initial = (post.author || '?').replace('@', '').charAt(0).toUpperCase();
        const categories = post.categories || [];
        const handle = (post.author || '').replace('@', '');
        
        return `
          <div class="ticker-item" onclick="filterByHandle('${handle}')" title="Show posts from ${post.author}">
            <div class="ticker-avatar">
              ${post.author_pfp 
                ? `<img src="${post.author_pfp}" alt="" onerror="this.outerHTML='${initial}'">`
                : initial
              }
            </div>
            <span class="ticker-handle">${post.author || 'Unknown'}</span>
            <div class="ticker-cats">
              ${categories.map(cat => `<span class="ticker-cat ${cat}">${cat}</span>`).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // Only duplicate for seamless scroll if we have enough posts (5+)
      // Otherwise just show them without scrolling animation
      if (recentPosts.length >= 5) {
        tickerTrack.innerHTML = tickerItems + tickerItems;
        tickerTrack.style.animation = 'ticker 30s linear infinite';
      } else {
        tickerTrack.innerHTML = tickerItems;
        tickerTrack.style.animation = 'none';
        tickerTrack.style.justifyContent = 'center';
      }
    }
    
    function filterByHandle(handle) {
      // Set search query to the clicked handle
      searchQuery = handle;
      document.getElementById('searchInput').value = handle;
      document.getElementById('searchClear').classList.add('visible');
      renderGrid();
      showToast(`Showing posts from @${handle}`);
    }

    function filterPosts(postList) {
      let filtered = postList;
      
      // Filter by search query (handle)
      if (searchQuery) {
        const query = searchQuery.toLowerCase().replace('@', '');
        filtered = filtered.filter(post => {
          const author = (post.author || '').toLowerCase().replace('@', '');
          return author.includes(query);
        });
      }
      
      // Filter by categories
      if (activeCategories.length > 0) {
        filtered = filtered.filter(post => {
          if (!post.categories || post.categories.length === 0) return false;
          return activeCategories.some(cat => post.categories.includes(cat));
        });
      }
      
      return filtered;
    }

    function renderGrid() {
      // Use followingPosts if on following tab, otherwise regular posts
      let sourceList = activeTab === 'following' ? followingPosts : posts;
      let filtered = filterPosts(sourceList);
      
      if (filtered.length === 0) {
        if (activeTab === 'following') {
          emptyState.querySelector('h2').textContent = 'No posts from people you follow';
          emptyState.querySelector('p').textContent = 'Follow some users to see their posts here!';
        } else if (posts.length === 0) {
          emptyState.querySelector('h2').textContent = 'No posts yet';
          emptyState.querySelector('p').textContent = 'Be the first to share a Twitter/X post!';
        } else if (searchQuery) {
          emptyState.querySelector('h2').textContent = `No posts from @${searchQuery.replace('@', '')}`;
          emptyState.querySelector('p').textContent = 'Try a different handle or clear the search.';
        } else {
          emptyState.querySelector('h2').textContent = 'No posts in this category';
          emptyState.querySelector('p').textContent = 'Try selecting different categories.';
        }
        emptyState.classList.remove('hidden');
        grid.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      grid.classList.remove('hidden');

      let sorted = [...filtered];
      if (activeTab === 'trending') {
        sorted.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
      } else if (activeTab === 'new' || activeTab === 'following') {
        sorted.sort((a, b) => b.id - a.id);
      } else if (activeTab === '7d') {
        // Filter to current week (Monday 00:00 to Sunday 23:59 UTC) and sort by likes
        const now = new Date();
        const utcNow = new Date(Date.UTC(
          now.getUTCFullYear(), 
          now.getUTCMonth(), 
          now.getUTCDate()
        ));
        const dayOfWeek = utcNow.getUTCDay();
        const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        const monday = new Date(utcNow);
        monday.setUTCDate(utcNow.getUTCDate() - diffToMonday);
        monday.setUTCHours(0, 0, 0, 0);
        
        sorted = sorted.filter(post => {
          const postDate = new Date(post.created_at);
          return postDate >= monday;
        });
        sorted.sort((a, b) => b.likes - a.likes);
      }

      grid.innerHTML = sorted.map(post => {
        const vote = votes[post.id];
        const initial = (post.author || '?').replace('@', '').charAt(0).toUpperCase();
        const isOwner = currentUser && post.user_id === currentUser.id;
        const isAdmin = currentUser && currentUser.is_admin;
        const canDelete = isOwner || isAdmin;
        const categories = post.categories || [];
        const userCanVote = currentUser && voteStatus.can_vote && voteStatus.votes_remaining > 0;
        const alreadyVoted = !!vote; // Already voted on this post
        
        let voteDisabledReason = '';
        if (!currentUser) {
          voteDisabledReason = 'Login to vote';
        } else if (!voteStatus.can_vote) {
          voteDisabledReason = `Rate ${voteStatus.ratings_needed} posts first`;
        } else if (voteStatus.votes_remaining <= 0 && !alreadyVoted) {
          voteDisabledReason = 'Daily vote limit reached';
        }

        return `
          <div class="post-card" onclick="openPostModal(${post.id})">
            ${canDelete ? `
            <button class="delete-btn" onclick="event.stopPropagation(); deletePost(${post.id})" title="Delete post">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
            ` : ''}
            ${isAdmin ? `
            <button class="edit-categories-btn" onclick="event.stopPropagation(); openEditCategoriesModal(${post.id})" title="Edit categories">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            ` : ''}
            ${post.image 
              ? `<img class="post-image" src="${post.image}" alt="" onerror="this.outerHTML='<div class=post-no-image>No image</div>'">`
              : '<div class="post-no-image">No image</div>'
            }
            <div class="post-body">
              <div class="post-header">
                <div class="post-author" onclick="event.stopPropagation(); openProfile('${post.user_username}')" style="cursor: pointer;">
                  <div class="author-avatar">
                    ${post.author_pfp 
                      ? `<img src="${post.author_pfp}" alt="" onerror="this.outerHTML='${initial}'">`
                      : initial
                    }
                  </div>
                  <span class="author-handle">${post.author || 'Unknown'}</span>
                </div>
                <div class="post-categories">
                  ${categories.map(cat => `<span class="cat-badge ${cat}">${cat}</span>`).join('')}
                </div>
              </div>
              <p class="post-text">${(post.text || 'No text').substring(0, 100)}${(post.text || '').length > 100 ? '...' : ''}</p>
              <div class="post-footer" onclick="event.stopPropagation()">
                <div class="post-footer-left">
                  <a href="${post.url}" target="_blank" class="twitter-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    View
                  </a>
                  <span class="post-time">${timeAgo(post.created_at)}</span>
                </div>
                <div class="vote-btns">
                  <button class="slop-btn ${post.slop_count > 0 ? 'has-reports' : ''} ${isOwner ? 'own-post' : ''}" 
                          onclick="openSlopModal(${post.id}, ${isOwner})" title="${isOwner ? 'View AI Slop reports' : 'Report as AI Slop'}">
                    <img src="assets/robot.png" alt="" class="robot-icon-small"> ${post.slop_count || 0}
                  </button>
                  <button class="vote-btn down ${vote === 'down' ? 'active' : ''}" 
                          onclick="handleVote(${post.id}, 'down')" ${(!userCanVote && !alreadyVoted) ? `disabled title="${voteDisabledReason}"` : ''}>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                    ${post.dislikes}
                  </button>
                  <button class="vote-btn up ${vote === 'up' ? 'active' : ''}" 
                          onclick="handleVote(${post.id}, 'up')" ${(!userCanVote && !alreadyVoted) ? `disabled title="${voteDisabledReason}"` : ''}>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    ${post.likes}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function openPostModal(postId) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      // Set image
      const imgEl = document.getElementById('postModalImage');
      if (post.image) {
        imgEl.src = post.image;
        imgEl.style.display = 'block';
      } else {
        imgEl.style.display = 'none';
      }
      
      // Set author
      const initial = (post.author || '?').replace('@', '').charAt(0).toUpperCase();
      document.getElementById('postModalAvatar').src = post.author_pfp || '';
      document.getElementById('postModalAvatar').onerror = function() { this.outerHTML = initial; };
      document.getElementById('postModalHandle').textContent = post.author || 'Unknown';
      document.getElementById('postModalAuthor').onclick = () => {
        closePostModal();
        openProfile(post.user_username);
      };
      
      // Set categories
      const cats = (post.categories || []).map(cat => `<span class="cat-badge ${cat}">${cat}</span>`).join('');
      document.getElementById('postModalCategories').innerHTML = cats;
      
      // Show existing text first with loading indicator
      const textEl = document.getElementById('postModalText');
      const readMoreEl = document.getElementById('postModalReadMore');
      textEl.textContent = (post.text || 'Loading full text...');
      readMoreEl.href = post.url;
      readMoreEl.textContent = 'View full post on X ';
      readMoreEl.style.display = 'inline-block';
      
      // Set time
      document.getElementById('postModalTime').textContent = timeAgo(post.created_at);
      
      // Set votes
      const vote = votes[postId];
      const isOwner = currentUser && post.user_id === currentUser.id;
      const userCanVote = currentUser && voteStatus.can_vote && voteStatus.votes_remaining > 0;
      const alreadyVoted = !!vote;
      
      let voteDisabledReason = '';
      if (!currentUser) voteDisabledReason = 'Login to vote';
      else if (!voteStatus.can_vote) voteDisabledReason = `Rate ${voteStatus.ratings_needed} posts first`;
      else if (voteStatus.votes_remaining <= 0 && !alreadyVoted) voteDisabledReason = 'Daily vote limit reached';
      
      document.getElementById('postModalVotes').innerHTML = `
        <button class="slop-btn ${post.slop_count > 0 ? 'has-reports' : ''}" 
                onclick="event.stopPropagation(); closePostModal(); openSlopModal(${post.id}, ${isOwner})">
          <img src="assets/robot.png" alt="" class="robot-icon-small"> ${post.slop_count || 0}
        </button>
        <button class="vote-btn down ${vote === 'down' ? 'active' : ''}" 
                onclick="handleVoteModal(${post.id}, 'down')" ${(!userCanVote && !alreadyVoted) ? `disabled title="${voteDisabledReason}"` : ''}>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
          ${post.dislikes}
        </button>
        <button class="vote-btn up ${vote === 'up' ? 'active' : ''}" 
                onclick="handleVoteModal(${post.id}, 'up')" ${(!userCanVote && !alreadyVoted) ? `disabled title="${voteDisabledReason}"` : ''}>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="18 15 12 9 6 15"/>
          </svg>
          ${post.likes}
        </button>
      `;
      
      // Show modal
      document.getElementById('postModal').classList.add('active');
      
      // Refetch full text from backend
      try {
        const res = await fetch(`${API_URL}/posts/${postId}/refetch`);
        if (res.ok) {
          const data = await res.json();
          if (data.text) {
            textEl.textContent = data.text;
          }
        }
      } catch (err) {
        console.log('Could not refetch text:', err);
      }
    }
    
    function closePostModal() {
      document.getElementById('postModal').classList.remove('active');
    }
    
    // Close post modal when clicking outside
    document.getElementById('postModal').addEventListener('click', (e) => {
      if (e.target.id === 'postModal') closePostModal();
    });
    
    async function handleVoteModal(postId, type) {
      await handleVote(postId, type);
      // Refresh the modal with updated data
      openPostModal(postId);
    }

    async function handleVote(postId, type) {
      if (!currentUser) {
        showToast('Please login to vote');
        return;
      }
      if (!voteStatus.can_vote) {
        showToast(`Rate ${voteStatus.ratings_needed} posts first`);
        showRatingModal();
        return;
      }
      
      // Check if already voted (can toggle)
      const existingVote = votes[postId];
      if (!existingVote && voteStatus.votes_remaining <= 0) {
        showToast('Daily vote limit reached (20)');
        return;
      }
      
      try {
        const result = await api(`/posts/${postId}/vote`, {
          method: 'POST',
          body: JSON.stringify({ type })
        });
        
        // Update local state
        const post = posts.find(p => p.id === postId);
        if (post) {
          post.likes = result.likes;
          post.dislikes = result.dislikes;
        }
        
        const wasNewVote = !votes[postId];
        
        if (result.user_vote) {
          votes[postId] = result.user_vote;
        } else {
          delete votes[postId];
        }
        
        // Update vote count if it was a new vote
        if (wasNewVote && result.user_vote) {
          voteStatus.votes_today++;
          voteStatus.votes_remaining = Math.max(0, voteStatus.votes_remaining - 1);
          updateAuthUI();
        }
        
        renderGrid();
      } catch (err) {
        showToast(err.message);
      }
    }

    let pendingDeletePostId = null;

    function deletePost(postId) {
      pendingDeletePostId = postId;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      pendingDeletePostId = null;
    }

    async function confirmDelete() {
      if (!pendingDeletePostId) return;
      const postId = pendingDeletePostId;
      closeDeleteModal();
      
      try {
        await api(`/posts/${postId}`, { method: 'DELETE' });
        posts = posts.filter(p => p.id !== postId);
        renderGrid();
        renderTicker();
        updateProfilePosts();
        showToast('Post deleted');
      } catch (err) {
        showToast(err.message);
      }
    }

    // AI Slop Modal Functions
    let currentSlopPostId = null;
    
    async function openSlopModal(postId, isOwner = false) {
      currentSlopPostId = postId;
      const modal = document.getElementById('slopModal');
      const formSection = document.getElementById('slopFormSection');
      const alreadyReported = document.getElementById('slopAlreadyReported');
      const ownPostMessage = document.getElementById('slopOwnPost');
      const reasonInput = document.getElementById('slopReason');
      
      // Reset form
      reasonInput.value = '';
      formSection.classList.add('hidden');
      alreadyReported.classList.add('hidden');
      ownPostMessage.classList.add('hidden');
      
      // Check if it's own post
      if (isOwner) {
        ownPostMessage.classList.remove('hidden');
      } else if (currentUser) {
        // Check if user already reported
        try {
          const check = await api(`/posts/${postId}/slop/check`);
          if (check.reported) {
            alreadyReported.classList.remove('hidden');
          } else {
            formSection.classList.remove('hidden');
          }
        } catch (err) {
          formSection.classList.remove('hidden');
        }
      }
      // If not logged in, just show reports (no form)
      
      // Load existing reports
      await loadSlopReports(postId);
      
      modal.classList.add('active');
    }
    
    function closeSlopModal() {
      document.getElementById('slopModal').classList.remove('active');
      currentSlopPostId = null;
    }

    // Edit Categories Modal (Admin)
    let currentEditPostId = null;
    
    function openEditCategoriesModal(postId) {
      currentEditPostId = postId;
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const modal = document.getElementById('editCategoriesModal');
      const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
      
      // Reset and set current categories
      checkboxes.forEach(cb => {
        cb.checked = (post.categories || []).includes(cb.value);
      });
      
      modal.classList.add('active');
    }
    
    function closeEditCategoriesModal() {
      document.getElementById('editCategoriesModal').classList.remove('active');
      currentEditPostId = null;
    }
    
    async function savePostCategories() {
      if (!currentEditPostId) return;
      
      const modal = document.getElementById('editCategoriesModal');
      const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
      const categories = Array.from(checkboxes).map(cb => cb.value);
      
      if (categories.length === 0) {
        alert('Please select at least one category');
        return;
      }
      
      try {
        const updated = await api(`/posts/${currentEditPostId}/categories`, {
          method: 'PUT',
          body: JSON.stringify({ categories })
        });
        
        // Update local posts array
        const idx = posts.findIndex(p => p.id === currentEditPostId);
        if (idx !== -1) {
          posts[idx] = updated;
        }
        
        closeEditCategoriesModal();
        renderGrid();
      } catch (err) {
        alert('Failed to update categories: ' + err.message);
      }
    }
    
    async function loadSlopReports(postId) {
      const listEl = document.getElementById('slopReportsList');
      const countEl = document.getElementById('slopCount');
      
      try {
        const reports = await api(`/posts/${postId}/slop`);
        countEl.textContent = reports.length;
        
        if (reports.length === 0) {
          listEl.innerHTML = '<div class="slop-empty">No reports yet</div>';
          return;
        }
        
        listEl.innerHTML = reports.map(report => `
          <div class="slop-report">
            <div class="slop-report-header">
              <span class="slop-report-user">@${report.username}</span>
              <span class="slop-report-time">${timeAgo(report.created_at)}</span>
            </div>
            <p class="slop-report-reason">${escapeHtml(report.reason)}</p>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<div class="slop-empty">Failed to load reports</div>';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    document.getElementById('submitSlop').addEventListener('click', async () => {
      if (!currentUser) {
        showToast('Please login to report');
        return;
      }
      
      const reason = document.getElementById('slopReason').value.trim();
      if (!reason) {
        showToast('Please explain why this is AI slop');
        return;
      }
      
      try {
        const result = await api(`/posts/${currentSlopPostId}/slop`, {
          method: 'POST',
          body: JSON.stringify({ reason })
        });
        
        // Update local post data
        const post = posts.find(p => p.id === currentSlopPostId);
        if (post) {
          post.slop_count = result.slop_count;
        }
        
        // Update UI
        document.getElementById('slopFormSection').classList.add('hidden');
        document.getElementById('slopAlreadyReported').classList.remove('hidden');
        await loadSlopReports(currentSlopPostId);
        renderGrid();
        
        showToast('Reported as AI Slop');
      } catch (err) {
        showToast(err.message);
      }
    });
    
    // Close slop modal when clicking outside
    document.getElementById('slopModal').addEventListener('click', (e) => {
      if (e.target.id === 'slopModal') closeSlopModal();
    });

    // Edit Categories Modal events
    document.getElementById('saveCategories').addEventListener('click', savePostCategories);
    
    document.getElementById('editCategoriesModal').addEventListener('click', (e) => {
      if (e.target.id === 'editCategoriesModal') closeEditCategoriesModal();
    });

    // Share form
    document.getElementById('shareForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const urlInput = document.getElementById('urlInput');
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const errorMsg = document.getElementById('errorMsg');
      const url = urlInput.value.trim();

      if (!currentUser) {
        errorMsg.textContent = 'Please login with Twitter first';
        errorMsg.classList.add('visible');
        return;
      }

      const selectedCategories = Array.from(document.querySelectorAll('.cat-checkbox:checked')).map(cb => cb.value);
      if (selectedCategories.length === 0) {
        errorMsg.textContent = 'Please select at least 1 category';
        errorMsg.classList.add('visible');
        return;
      }

      errorMsg.classList.remove('visible');
      submitBtn.disabled = true;
      submitText.innerHTML = '<div class="spinner"></div> Fetching...';

      try {
        // Fetch preview
        const preview = await api('/preview', {
          method: 'POST',
          body: JSON.stringify({ url })
        });
        
        // Create post
        const newPost = await api('/posts', {
          method: 'POST',
          body: JSON.stringify({
            url,
            image: preview.image,
            text: preview.text,
            author: preview.author,
            author_pfp: preview.author_pfp,
            categories: selectedCategories
          })
        });
        
        posts.unshift(newPost);
        urlInput.value = '';
        document.querySelectorAll('.cat-checkbox').forEach(cb => cb.checked = false);
        shareModal.classList.remove('active');
        showToast('Post shared!');
        renderGrid();
        renderTicker();
        updateProfilePosts();
      } catch (err) {
        errorMsg.textContent = err.message;
        errorMsg.classList.add('visible');
      } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Fetch & Share';
      }
    });

    // Event listeners
    document.getElementById('openShare').addEventListener('click', () => shareModal.classList.add('active'));
    document.getElementById('emptyShare').addEventListener('click', () => shareModal.classList.add('active'));
    document.getElementById('closeShare').addEventListener('click', () => shareModal.classList.remove('active'));
    shareModal.addEventListener('click', (e) => { if (e.target === shareModal) shareModal.classList.remove('active'); });

    // Rating modal buttons
    document.getElementById('rateFire').addEventListener('click', () => handleRating('fire'));
    document.getElementById('ratePass').addEventListener('click', () => handleRating('pass'));

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value.trim();
      searchClear.classList.toggle('visible', searchQuery.length > 0);
      renderGrid();
    });
    
    searchClear.addEventListener('click', () => {
      searchInput.value = '';
      searchQuery = '';
      searchClear.classList.remove('visible');
      renderGrid();
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        // Remove active from all tabs (both mobile and desktop)
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        // Add active to all tabs with same data-tab value
        document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('active'));
        activeTab = tabName;
        renderGrid();
      });
    });

    document.querySelectorAll('.cat-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        const cat = btn.dataset.cat;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
          activeCategories.push(cat);
        } else {
          activeCategories = activeCategories.filter(c => c !== cat);
        }
        renderGrid();
      });
    });

    loginBtn.addEventListener('click', () => {
      window.location.href = `${API_URL}/auth/login`;
    });

    profileBtn.addEventListener('click', () => {
      profilePanel.classList.add('active');
      panelBackdrop.classList.add('active');
    });

    document.getElementById('closePanel').addEventListener('click', () => {
      profilePanel.classList.remove('active');
      panelBackdrop.classList.remove('active');
    });
    
    panelBackdrop.addEventListener('click', () => {
      profilePanel.classList.remove('active');
      panelBackdrop.classList.remove('active');
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await api('/auth/logout', { method: 'POST' });
      } catch (err) {}
      localStorage.removeItem('postflow_token');
      authToken = null;
      currentUser = null;
      votes = {};
      profilePanel.classList.remove('active');
      panelBackdrop.classList.remove('active');
      updateAuthUI();
      renderGrid();
      showToast('Logged out');
    });

    // Stats button
    document.getElementById('statsBtn').addEventListener('click', () => {
      openStatsModal();
    });
    
    document.getElementById('statsModal').addEventListener('click', (e) => {
      // Block clicks on backdrop - only close via X button
      if (e.target.id === 'statsModal') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    });
    
    // Share on X button
    document.getElementById('shareXBtn').addEventListener('click', () => {
      shareStatsOnX();
    });
    
    // Download stats button
    document.getElementById('downloadStatsBtn').addEventListener('click', () => {
      downloadStats();
    });

    function openStatsModal() {
      if (!currentUser) return;
      
      // Close the sidebar/profile panel and its backdrop
      profilePanel.classList.remove('active');
      panelBackdrop.classList.remove('active');
      
      // Update profile info
      document.getElementById('statsPfp').src = currentUser.pfp || '';
      document.getElementById('statsHandle').textContent = '@' + currentUser.username;
      
      // Calculate stats from user's posts
      const userPosts = posts.filter(p => p.user_id === currentUser.id);
      
      const categories = ['art', 'video', 'meme', 'tech', 'shitpost', 'testnet'];
      const catCounts = {};
      let totalLikes = 0;
      let totalSlop = 0;
      
      categories.forEach(cat => catCounts[cat] = 0);
      
      userPosts.forEach(post => {
        totalLikes += parseInt(post.likes) || 0;
        totalSlop += parseInt(post.slop_count) || 0;
        (post.categories || []).forEach(cat => {
          const catLower = cat.toLowerCase();
          if (catCounts[catLower] !== undefined) catCounts[catLower]++;
        });
      });
      
      // Update summary stats
      document.getElementById('statTotalPosts').textContent = userPosts.length;
      document.getElementById('statTotalLikes').textContent = totalLikes;
      document.getElementById('statTotalSlop').textContent = totalSlop;
      
      // Calculate grades and draw hexagon
      const maxCount = Math.max(...Object.values(catCounts), 1);
      const grades = {};
      
      categories.forEach(cat => {
        const count = catCounts[cat];
        const grade = getGrade(count, maxCount);
        grades[cat] = grade;
        document.getElementById(`grade${capitalize(cat)}`).textContent = grade;
      });
      
      // AI grade (percentage - more slop reports = higher %)
      let aiPercent = 0;
      if (userPosts.length > 0 && totalSlop > 0) {
        const avgReportsPerPost = totalSlop / userPosts.length;
        aiPercent = Math.min(100, Math.round(avgReportsPerPost * 20));
      }
      document.getElementById('gradeAI').textContent = aiPercent + '%';
      
      // Draw hexagon chart
      drawHexagonChart(catCounts, maxCount);
      
      document.getElementById('statsModal').classList.add('active');
    }
    
    async function shareStatsOnX() {
      if (!currentUser) return;
      
      const shareBtn = document.getElementById('shareXBtn');
      const originalText = shareBtn.innerHTML;
      
      try {
        // Show loading state
        shareBtn.innerHTML = '<span class="spinner"></span> Capturing...';
        shareBtn.disabled = true;
        
        // Hide the close button and buttons for screenshot
        const closeBtn = document.querySelector('.stats-close');
        const statsButtons = document.querySelector('.stats-buttons');
        const statsContent = document.getElementById('statsContent');
        closeBtn.style.display = 'none';
        statsButtons.style.display = 'none';
        
        // Capture the stats content as image
        const canvas = await html2canvas(statsContent, {
          backgroundColor: '#0d0e14',
          scale: 2, // Higher quality
          useCORS: true, // Allow cross-origin images (profile pics)
          allowTaint: true,
          logging: false
        });
        
        // Show buttons again
        closeBtn.style.display = '';
        statsButtons.style.display = '';
        
        // Convert to blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // Try to copy to clipboard
        try {
          await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
          ]);
          
          showToast(' Stats image copied! Opening Twitter...');
          
          // Open Twitter compose
          const tweetText = `My Magicblob Stats\n\n [paste the image]\n\n magicblobs.xyz`;
          const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
          
          setTimeout(() => {
            window.open(tweetUrl, '_blank', 'width=550,height=520');
          }, 500);
          
        } catch (clipboardErr) {
          // Clipboard API not supported, download instead
          console.log('Clipboard not supported, downloading...');
          
          const link = document.createElement('a');
          link.download = `postflow-stats-${currentUser.username}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          
          showToast(' Stats image downloaded! Attach it to your tweet');
          
          // Open Twitter compose
          const tweetText = `My Magicblob Stats \n\n [Paste the Image]`;
          const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
          
          setTimeout(() => {
            window.open(tweetUrl, '_blank', 'width=550,height=520');
          }, 500);
        }
        
      } catch (err) {
        console.error('Screenshot error:', err);
        showToast('Failed to capture stats. Try again!');
      } finally {
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;
      }
    }
    
    async function downloadStats() {
      if (!currentUser) return;
      
      const downloadBtn = document.getElementById('downloadStatsBtn');
      const originalText = downloadBtn.innerHTML;
      
      try {
        // Show loading state
        downloadBtn.innerHTML = '<span class="spinner"></span> Capturing...';
        downloadBtn.disabled = true;
        
        // Hide the close button and buttons for screenshot
        const closeBtn = document.querySelector('.stats-close');
        const statsButtons = document.querySelector('.stats-buttons');
        const statsContent = document.getElementById('statsContent');
        closeBtn.style.display = 'none';
        statsButtons.style.display = 'none';
        
        // Capture the stats content as image
        const canvas = await html2canvas(statsContent, {
          backgroundColor: '#0d0e14',
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false
        });
        
        // Show buttons again
        closeBtn.style.display = '';
        statsButtons.style.display = '';
        
        // Download the image
        const link = document.createElement('a');
        link.download = `magicblob-stats-${currentUser.username}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showToast(' Stats image downloaded!');
        
      } catch (err) {
        console.error('Screenshot error:', err);
        showToast('Failed to capture stats. Try again!');
      } finally {
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }
    }
    
    function getGrade(count, max) {
      if (count === 0) return '-';
      const ratio = count / max;
      if (ratio >= 0.9) return 'S+';
      if (ratio >= 0.7) return 'S';
      if (ratio >= 0.5) return 'A';
      if (ratio >= 0.3) return 'B';
      if (ratio >= 0.1) return 'C';
      return 'D';
    }
    
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    function drawHexagonChart(catCounts, maxCount) {
      const svg = document.getElementById('hexChart');
      const centerX = 100;
      const centerY = 100;
      const maxRadius = 70;
      const minRadius = 15;
      
      const categories = ['art', 'video', 'meme', 'tech', 'shitpost', 'testnet'];
      
      // Draw background hexagons (grid lines)
      const bgHexes = svg.querySelectorAll('.hex-bg');
      [0.33, 0.66, 1].forEach((scale, i) => {
        if (bgHexes[i]) {
          const points = getHexagonPoints(centerX, centerY, maxRadius * scale, 6);
          bgHexes[i].setAttribute('points', points);
        }
      });
      
      // Calculate data points - ensure radius never exceeds maxRadius
      const dataPoints = categories.map((cat, i) => {
        const count = catCounts[cat] || 0;
        const ratio = maxCount > 0 ? Math.min(count / maxCount, 1) : 0; // Cap at 1
        const radius = Math.min(minRadius + (maxRadius - minRadius) * ratio, maxRadius); // Double cap
        const angle = (Math.PI / 2) - (i * Math.PI * 2 / 6);// Start from top
        const x = centerX + radius * Math.cos(angle);
        const y = centerY - radius * Math.sin(angle);
        return `${x},${y}`;
      });
      
      document.getElementById('hexData').setAttribute('points', dataPoints.join(' '));
    }
    
    function getHexagonPoints(cx, cy, radius, sides) {
      const points = [];
      for (let i = 0; i < sides; i++) {
        const angle = (Math.PI / 2) + (i * Math.PI * 2 / sides);
        const x = cx + radius * Math.cos(angle);
        const y = cy - radius * Math.sin(angle);
        points.push(`${x},${y}`);
      }
      return points.join(' ');
    }

    // ============================================================
    // PROFILE MODAL FUNCTIONS
    // ============================================================
    
    async function openProfile(username) {
      if (!username) return;
      
      try {
        const profile = await api(`/users/${username}`);
        currentProfileUser = profile;
        currentProfileTab = 'posts';
        
        // Populate modal
        document.getElementById('profileModalPfp').src = profile.pfp || '';
        document.getElementById('profileModalName').textContent = profile.name || profile.username;
        document.getElementById('profileModalUsername').textContent = '@' + profile.username;
        document.getElementById('profileModalBio').textContent = profile.bio || '';
        document.getElementById('profileModalFollowers').textContent = profile.followers || 0;
        document.getElementById('profileModalFollowing').textContent = profile.following || 0;
        document.getElementById('profileModalPosts').textContent = profile.posts_count || 0;
        
        // Update follow button
        const followBtn = document.getElementById('profileFollowBtn');
        const actionsEl = document.getElementById('profileActions');
        
        if (profile.is_own_profile) {
          actionsEl.style.display = 'none';
        } else {
          actionsEl.style.display = 'flex';
          if (profile.is_following) {
            followBtn.textContent = 'Following';
            followBtn.className = 'follow-btn following';
          } else {
            followBtn.textContent = 'Follow';
            followBtn.className = 'follow-btn follow';
          }
        }
        
        // Reset tabs
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.profile-tab[data-ptab="posts"]').classList.add('active');
        
        // Load posts
        renderProfilePosts(profile.posts || []);
        
        document.getElementById('userProfileModal').classList.add('active');
      } catch (err) {
        showToast('Failed to load profile');
        console.error(err);
      }
    }
    
    function closeProfileModal() {
      document.getElementById('userProfileModal').classList.remove('active');
      currentProfileUser = null;
    }
    
    // Close modal when clicking outside
    document.getElementById('userProfileModal').addEventListener('click', (e) => {
      if (e.target.id === 'userProfileModal') closeProfileModal();
    });
    
    async function toggleFollow() {
      if (!currentUser || !currentProfileUser) {
        showToast('Please login to follow');
        return;
      }
      
      const btn = document.getElementById('profileFollowBtn');
      const isFollowing = currentProfileUser.is_following;
      
      try {
        btn.disabled = true;
        
        if (isFollowing) {
          const result = await api(`/users/${currentProfileUser.username}/unfollow`, { method: 'POST' });
          currentProfileUser.is_following = false;
          currentProfileUser.followers = result.followers;
          btn.textContent = 'Follow';
          btn.className = 'follow-btn follow';
          followingUserIds.delete(currentProfileUser.id);
        } else {
          const result = await api(`/users/${currentProfileUser.username}/follow`, { method: 'POST' });
          currentProfileUser.is_following = true;
          currentProfileUser.followers = result.followers;
          btn.textContent = 'Following';
          btn.className = 'follow-btn following';
          followingUserIds.add(currentProfileUser.id);
        }
        
        document.getElementById('profileModalFollowers').textContent = currentProfileUser.followers;
        fetchFollowingFeed(); // Refresh following feed
        
      } catch (err) {
        showToast(err.message || 'Failed to update follow');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function switchProfileTab(tab) {
      currentProfileTab = tab;
      
      // Update tab UI
      document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.profile-tab[data-ptab="${tab}"]`).classList.add('active');
      
      const content = document.getElementById('profileContent');
      content.innerHTML = '<div class="empty-list">Loading...</div>';
      
      try {
        if (tab === 'posts') {
          renderProfilePosts(currentProfileUser.posts || []);
        } else if (tab === 'followers') {
          const followers = await api(`/users/${currentProfileUser.username}/followers`);
          renderUserList(followers, 'followers');
        } else if (tab === 'following') {
          const following = await api(`/users/${currentProfileUser.username}/following`);
          renderUserList(following, 'following');
        }
      } catch (err) {
        content.innerHTML = '<div class="empty-list">Failed to load</div>';
      }
    }
    
    function showProfileFollowers() {
      switchProfileTab('followers');
    }
    
    function showProfileFollowing() {
      switchProfileTab('following');
    }
    
    function renderProfilePosts(userPosts) {
      const content = document.getElementById('profileContent');
      
      if (userPosts.length === 0) {
        content.innerHTML = '<div class="empty-list">No posts yet</div>';
        return;
      }
      
      content.innerHTML = `
        <div class="profile-posts-grid">
          ${userPosts.map(post => `
            <div class="profile-post-thumb" onclick="window.open('${post.url}', '_blank')">
              ${post.image 
                ? `<img src="${post.image}" alt="" onerror="this.outerHTML='<div class=no-img>No image</div>'">`
                : '<div class="no-img">No image</div>'
              }
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderUserList(users, type) {
      const content = document.getElementById('profileContent');
      
      if (users.length === 0) {
        content.innerHTML = `<div class="empty-list">No ${type} yet</div>`;
        return;
      }
      
      content.innerHTML = `
        <div class="user-list">
          ${users.map(user => {
            const isMe = currentUser && user.id === currentUser.id;
            const showFollowBtn = currentUser && !isMe;
            
            return `
              <div class="user-card">
                <div class="user-card-avatar" onclick="openProfile('${user.username}')">
                  <img src="${user.pfp || ''}" alt="" onerror="this.style.background='var(--bg)'">
                </div>
                <div class="user-card-info" onclick="openProfile('${user.username}')">
                  <div class="user-card-name">${user.name || user.username}</div>
                  <div class="user-card-username">@${user.username}</div>
                </div>
                ${showFollowBtn ? `
                  <button class="follow-btn ${user.is_following ? 'following' : 'follow'}" 
                          onclick="event.stopPropagation(); quickFollow('${user.username}', this)">
                    ${user.is_following ? 'Following' : 'Follow'}
                  </button>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    async function quickFollow(username, btn) {
      if (!currentUser) return;
      
      const isFollowing = btn.classList.contains('following');
      
      try {
        btn.disabled = true;
        
        if (isFollowing) {
          await api(`/users/${username}/unfollow`, { method: 'POST' });
          btn.textContent = 'Follow';
          btn.className = 'follow-btn follow';
        } else {
          await api(`/users/${username}/follow`, { method: 'POST' });
          btn.textContent = 'Following';
          btn.className = 'follow-btn following';
        }
        
        fetchFollowingFeed();
        
      } catch (err) {
        showToast(err.message || 'Failed');
      } finally {
        btn.disabled = false;
      }
    }

    // Close delete modal when clicking outside
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });

    // ============================================================
    // SCROLL HANDLING
    // ============================================================
    
    let lastScrollY = 0;
    const header = document.querySelector('.header');
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    
    function handleScroll() {
      const currentScrollY = window.scrollY;
      
      // Show/hide scroll-to-top button
      if (currentScrollY > 300) {
        scrollTopBtn.classList.add('visible');
      } else {
        scrollTopBtn.classList.remove('visible');
      }
      
      // Collapse header on mobile when scrolling down
      if (window.innerWidth <= 700) {
        if (currentScrollY > 100) {
          header.classList.add('collapsed');
        } else {
          header.classList.remove('collapsed');
        }
      }
      
      lastScrollY = currentScrollY;
    }
    
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    
    // ============================================================
    // GRID TOGGLE (Mobile)
    // ============================================================
    
    let currentGridMode = parseInt(localStorage.getItem('gridMode')) || 1;
    // If saved value was 3, reset to 1
    if (currentGridMode > 2) currentGridMode = 1;
    
    function toggleGridMode() {
      // Cycle through 1 -> 2 -> 1
      currentGridMode = currentGridMode >= 2 ? 1 : currentGridMode + 1;
      applyGridMode();
      localStorage.setItem('gridMode', currentGridMode);
    }
    
    function applyGridMode() {
      const grid = document.getElementById('grid');
      const gridCount = document.getElementById('gridCount');
      
      // Remove all grid mode classes
      grid.classList.remove('grid-1col', 'grid-2col');
      
      // Apply current mode
      grid.classList.add(`grid-${currentGridMode}col`);
      gridCount.textContent = currentGridMode;
    }
    
    // Apply saved grid mode on page load
    if (window.innerWidth <= 500) {
      applyGridMode();
    }
    
    // Debounce scroll handler for performance
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) {
        window.cancelAnimationFrame(scrollTimeout);
      }
      scrollTimeout = window.requestAnimationFrame(handleScroll);
    });
    
    // Remove collapsed class when resizing to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth > 700) {
        header.classList.remove('collapsed');
      }
      
      // Handle grid mode on resize
      const grid = document.getElementById('grid');
      if (window.innerWidth > 500) {
        grid.classList.remove('grid-1col', 'grid-2col');
      } else {
        applyGridMode();
      }
    });

    // Init
    fetchPosts();
    fetchUser().then(fetchUserVotes);
  </script>
  
</body>
</html>
